#!/bin/bash
# VPS Provisioning Wrapper
# Run from local machine - executes provisioning on VPS via SSH

set -euo pipefail

# ======================
# LOAD CONFIG FROM .env
# ======================
if [ -f "$(dirname "$0")/.env" ]; then
  # shellcheck source=/dev/null
  source "$(dirname "$0")/.env"
fi

# ======================
# VALIDATE CONFIG
# ======================
VPS_HOST="${VPS_HOST:-}"
VPS_USER="${VPS_USER:-}"
VPS_HOSTNAME="${VPS_HOSTNAME:-}"
VPS_TIMEZONE="${VPS_TIMEZONE:-}"
VPS_SSH_PUBKEY="${VPS_SSH_PUBKEY:-}"

if [ -z "$VPS_HOST" ]; then
  echo "[ERROR] VPS_HOST is required. Set VPS_HOST in .env file."
  exit 1
fi

if [ -z "$VPS_USER" ]; then
  echo "[ERROR] VPS_USER is required. Set VPS_USER in .env file."
  exit 1
fi

if [ -z "$VPS_HOSTNAME" ]; then
  echo "[ERROR] VPS_HOSTNAME is required. Set VPS_HOSTNAME in .env file."
  exit 1
fi

if [ -z "$VPS_TIMEZONE" ]; then
  echo "[ERROR] VPS_TIMEZONE is required. Set VPS_TIMEZONE in .env file."
  exit 1
fi

if [ -z "$VPS_SSH_PUBKEY" ]; then
  echo "[ERROR] VPS_SSH_PUBKEY is required. Set VPS_SSH_PUBKEY in .env file."
  exit 1
fi

# ======================
# SSH TO VPS AND EXECUTE PROVISIONING
# ======================
echo "[INFO] Connecting to VPS: $VPS_HOST"
echo "[INFO] Executing provisioning script on VPS..."

REMOTE_SCRIPT="$(dirname "$0")/provision-remote"
ssh-copy-id -i "$VPS_SSH_PUBKEY" root@"$VPS_HOST"
ssh root@"$VPS_HOST" "VPS_USER=$VPS_USER VPS_HOSTNAME=$VPS_HOSTNAME VPS_TIMEZONE=$VPS_TIMEZONE bash -s" < "$REMOTE_SCRIPT"
